# 데이터 수집 파이프라인 아키텍처 결정: EC2 + Docker + Airflow 채택
<div align="right">📅 2025-12-09</div>

> 💡 요약 <br><br>
> 본 프로젝트는 일일 배치 데이터 수집을 위해 **EC2 + Docker + Airflow** 아키텍처를 채택하였다. 대량의 API 요청 조합(약 2,735개)을 안정적으로 처리하고, 비용 효율성을 위해 EventBridge + Lambda를 통한 인스턴스 자동 기동/정지 방식을 도입하였다. Lambda나 Fargate 대신 EC2를 선택한 이유는 로컬 환경과의 일관성, 안정적인 데이터 수집 및 S3 적재, 그리고 관리 포인트 최소화를 통한 운영 효율성 확보에 있다.

## 1. Context (배경 및 문제 정의)

본 프로젝트에서는 공공 농산물 가격 데이터를 일일 배치로 수집하여 분석 및 시각화하는 데이터 파이프라인을 구축하고자 하였다. 데이터 수집 대상은 5개의 API이며, 이 중 4개는 다양한 파라미터 조합을 통해 데이터를 받아와야 하는 특성이 있었다.

**수집 데이터 특징**
- 배치 주기: 1일 1배치
- 대상 API 수: 5개
- 파라미터 조합이 필요한 API: 4개
- 일일 요청 파라미터 예상 조합 수: 약 2,735개
    - 1번 API: 60개 (도/소매 × 부류코드(6개) × 지역(5개))
    - 13번 API (친환경): 1,160개 (부류+품목+품종코드(232개) × 지역(5개))
    - 17번 API: 1,510개 (부류+품목+품종코드+등급코드(302개) × 지역(5개))
    - 10번 API: 5개 (지역)

이러한 상황에서 클라우드 환경에서 데이터 수집 아키텍처를 어떤 구조로 구성할 것인지에 대한 설계 선택지가 존재했다.

## 2. Decision (결정)

- EC2 인스턴스에 Docker 기반 Airflow 구동를 채택
    - EventBridge + Lambda를 통한 인스턴스 자동 기동/정지
    - 일일 배치 수집 시점에만 인스턴스 활성화하여 비용 최적화

하는 **컨테이너 기반 데이터 수집 아키텍처**를 구성하였다.

## 3. Alternatives Considered (고려했던 대안들)

### 1.1 서버리스 기반 구조 (Lambda + 로컬 Airflow)

- Lambda 함수를 통한 API 호출 및 데이터 수집
- Backfill 작업은 로컬 환경의 Airflow로 수행

**장점**

- 응답 데이터 양이 작아 가볍게 구동 가능
- 비용 최소화하여 운영 가능

**단점**

- Backfill 데이터를 각자 로컬에서 구동할 경우, 수집된 데이터를 클라우드에 업로드하기 위한 추가 작업 필요
- Lambda 최대 실행 시간이 함수당 최대 15분인 것으로 확인 → 호출 조합 수가 많은 경우(약 2,735개) 적절한 구성인가?
- 대량의 API 요청 조합을 처리하기 위한 오케스트레이션 로직 구현 복잡도 증가

### 1.2 컨테이너 기반 오케스트레이션 구조 (EC2 + Docker + Airflow)

- EC2 인스턴스에 Docker 기반 Airflow 구동
- Airflow를 통한 데이터 수집 오케스트레이션

**장점**

- 안정적인 데이터 수집 가능
- 백필 수집 데이터도 배치성 데이터와 관계없이 바로 S3로 적재 가능
- 관리 포인트 최소화

**단점**

- 1일 1배치로 수집이 실행되는 특정 시간대만 사용이 필요한데 종일 켜두는 것은 자원 낭비 일 수 있음 <br> → 인스턴스를 켜고 끄는 것을 EventBridge + Lambda로 구성 가능

### AWS Airflow 배포 옵션 비교

컨테이너 기반 구조를 선택한 후, AWS에서 Airflow를 배포하는 방법에 대한 추가 검토를 진행하였다.

| 특징 | EC2 (t3.medium) | Fargate (ECS/EKS) | Amazon MWAA |
| --- | --- | --- | --- |
| **서버 관리** | 사용자 직접 관리 | AWS 관리 (서버리스) | AWS 완전 관리 |
| **운영 부담** | 높음 | 낮음 | 매우 낮음 |
| **비용 모델** | 시간당 고정 비용 | 사용한 vCPU/Memory 초 단위 과금 | 환경 가동 시간 + Worker 사용량 |
| **유연성/제어** | 높음 | 중간 | 낮음 |
| **오토 스케일링** | 직접 구현 필요 | 지원 (비교적 쉬움) | AWS 자동 관리 |
| **기본 단가 (예상)** | **약 $0.0416/시간** (Linux, 서울 리전, On-Demand) | **약 $0.05/vCPU/시간 + $0.0055/GB/시간** | **최소 $1.00/시간 (소형 환경 기준)** |
| **총 소유 비용 (TCO)** | 가변적 (운영 인건비 포함 시 ↑) | 워크로드에 따라 효율적 | 예측 가능, 단순함 |

**용어 설명**

- **MWAA**: 완전 관리형으로 제공하는 Airflow 서비스
- **Fargate**: 사용자가 서버 관리에 신경 쓸 필요 없이 **컨테이너를 실행할 수 있는 서버리스 컴퓨팅 엔진**

## 4. Rationale (결정의 이유)

- **운영 안정성 확보**
    - Airflow 서비스의 안정성을 바탕으로 backfill 수행 및 데이터 수집 과정을 안정적으로 관리 가능
    - 대량의 API 요청 조합(약 2,735개)을 체계적으로 처리할 수 있음
- **로컬 환경과의 일관성 유지**
    - Fargate 서비스에서 Airflow 구동할 경우 Webserver, Scheduler, Worker, Metadata DB, Message Broker(Redis/RabbitMQ) 등 여러 컴포넌트에 대한 초기 설정이 필요함
    - EC2에 Docker 이미지를 바로 올릴 경우, 비교적 로컬에서 테스트한 환경 그대로 구동 가능하여 개발-운영 환경 간 일관성 확보
- **비용 효율성**
    - 데이터 수집 시점에만 인스턴스 활성화가 필요했는데, Docker 이미지로 배포하더라도 필요한 시간만 효율적으로 사용 가능함을 확인
    - EventBridge + Lambda를 통한 인스턴스 자동 기동/정지로 24시간 운영 대비 비용 절감

## 5. Consequences (영향 및 결과)

### 긍정적 영향

- 대량의 API 요청 조합을 안정적으로 처리할 수 있는 수집 체계 구축
- 로컬 개발 환경과 운영 환경의 일관성 유지로 개발 효율성 향상
- EventBridge + Lambda를 통한 인스턴스 자동 관리로 비용 효율성 확보
- 데이터 수집부터 S3 적재까지의 파이프라인 구조 단순화로 유지보수성 향상
- Airflow의 재시도 및 모니터링 기능을 통한 데이터 수집 안정성 확보

### 한계 및 트레이드오프

- EC2 인스턴스 관리 부담이 존재하며, 서버리스 옵션 대비 운영 복잡도가 높음
- 인스턴스 크기(t3.medium) 제약으로 인한 동시 처리 능력의 한계 존재
- MWAA나 Fargate 대비 초기 설정은 단순하나, 지속적인 서버 관리 필요

**일일 배치 데이터 수집에 가장 적합한 구조**로 EC2 + Docker + Airflow 기반 설계를 채택하였다.

## 6. Related Decisions (관련 ADR 문서)

- 없음

## 7. References (참고 자료)

- [(2.2) 파이프라인 초안 구성](https://www.notion.so/2-2-2b96e9180a968050a29eef185635c054?pvs=21)