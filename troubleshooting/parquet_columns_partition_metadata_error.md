# Parquet 내부 컬럼과 파티션 메타데이터 간 정합성 오류 해결

>💡 요약 <br><br> Athena가 파티션 메타데이터를 우선시하면서 발생한 컬럼 충돌 문제를 해결하기 위해 Silver 테이블을 파티션 기반 구조로 재정의하였으며, 이를 통해 오류를 제거하고 성능 최적화와 유지보수 용이성을 동시에 확보하고자 함.

# 1. 문제 상황

Silver Layer 데이터를 Parquet 포맷으로 저장하고 이를 Athena + dbt를 통해 Data mart(gold layer)로 변환하는 과정에서, **파티션 컬럼(year, month, dt)이 정상적으로 인식되지 않아 조회 및 필터링이 실패하는 문제가 발생하였다.**

구체적으로 dbt 모델에서 다음과 같은 현상이 확인되었다.

- 데이터 정합성 오류: `SELECT` 절에서 파티션 컬럼 조회 시 값이 `NULL`로 반환됨
- 쿼리 필터링 오류: `WHERE` 조건절에 파티션 키 사용 시 결과가 반환되지 않음
- 결과 유실: S3에 데이터가 물리적으로 존재함에도 불구하고 Athena 상에서 레코드가 누락되는 현상 확인

# 2. 원인 분석

## 2.1 Parquet 파일과 Athena의 파티션 처리 방식의 충돌

파티션 키와 데이터 컬럼 간의 네임스페이스 충돌 (Column Shadowing)

문제는 **Parquet 파일 내부 컬럼과 Athena 파티션 컬럼이 중복으로 정의되어 발생했다.**

Athena는 Hive 메타스토어 방식을 따르며, 파티션 컬럼을 **파일 내부가 아닌 S3 경로(Directory Structure)**에서 추출한다. 따라서 파일의 경로 형식이 Hive-style이 아닐 경우 파일 내부의 데이터까지 무시하게 되는 구조적 결함 발생할 수 있다.

Silver 전처리 단계에서 생성된 Parquet 파일에는 이미 다음 컬럼이 포함되어 있었다.

- `year`
- `month`
- `dt`

동시에 Glue Data Catalog에서 해당 테이블은 다음과 같이 정의되어 있었다.

```sql
PARTITIONED BY (
year STRING,
month STRING,
  dt STRING
)
```

이로 인해 Parquet 파일 내부에 존재하는 `year`, `month`, `dt` 컬럼은 **무시되거나 파티션 메타데이터와 충돌**하게 되었고, Parquet 내부 컬럼과 Athena 파티션 메타데이터가 충돌하는 ‘이중 파티션 컬럼 문제’가 발생하였다.



## 2.2 레이어 설계 전략의 불일치

Silver Layer는 이미 정제된 '컬럼 기반 데이터'임에도 불구하고, 메타데이터 관리 상 불필요하게 '파티션 테이블' 형식을 강제하여 논리적 스키마와 물리적 데이터 구조 간의 괴리가 발생하였다.


# 3. 해결 방안

문제 해결을 위해 다음과 같은 설계 원칙을 재정립하였다.

- **Parquet 파일 내부에는 파티션 컬럼을 포함하지 않는다**
- 파티션을 사용할 경우, 디렉토리 구조와 Glue 파티션 메타데이터로만 관리한다
- Silver Layer는 컬럼 기반 테이블로 정의하여, 파티션 메타데이터와의 불필요한 충돌을 제거한다.

분석 편의성과 성능 최적화의 관점에서 파티션을 활용하기로 결정하였다. 효율적인 쿼리 수행과 데이터 스캔 최소화하기에 파티션이 유리하다고 판단하였기 때문이다. 

이에 따라 다음과 같은 방식으로 스키마 구조를 재설계 하였다.

- Silver Layer에서 `year`, `month`, `dt` 컬럼을 제거
- Glue Data Catalog 상의 Silver 테이블을 **파티션 테이블(partitioned table)** 로 재정의


# 4. 기존 구조 → 변경된 구조

| **구분** | **AS-IS (기존 구조)** | **TO-BE (개선 구조)** |
| --- | --- | --- |
| **Data File** | `year, month, dt` 포함 | `year, month, dt` 제거 |
| **Metadata** | **일반 Column으로 정의** | `PARTITIONED BY` 정의 |
| **참조 방식** | Parquet 내부 스키마 직접 참조 | S3 디렉토리 경로 참조 |
| **결과** | 스키마 충돌 및 조회 오류 | 스키마 일관성 확보 및 쿼리 정상화 |

# 5. 변경으로 인해 개선된 부분

구조 변경 이후 다음과 같은 개선 효과를 확인할 수 있었다.

- dbt 모델에서 날짜 컬럼 조회 및 필터 조건이 정상 동작
- Silver → data mart 변환 과정에서 데이터 누락 문제 해소
- Athena + Parquet 환경에서의 파티션 설계 원칙 명확화
- 이후 신규 테이블 설계 시 동일한 오류 재발 방지 및 유지보수와 확장성 용이