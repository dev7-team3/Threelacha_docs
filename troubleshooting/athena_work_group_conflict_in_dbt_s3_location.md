# Athena μ›ν¬κ·Έλ£Ή μ„¤μ • μ¶©λμ— λ”°λ¥Έ dbt λ¨λΈ S3 μ €μ¥ κ²½λ΅(location) λ―Έμ μ© λ¬Έμ 


> π’΅μ”μ•½ <br><br> dbt λ¨λΈμ—μ„ μ§€μ •ν• S3 μ €μ¥ κ²½λ΅κ°€ λ¬΄μ‹λλ” ν„μƒμ„ λ¶„μ„ν•μ—¬, μ‹¤μ  μΏΌλ¦¬ μ‘μ—…μ„ μν–‰ν•λ” Athena μ›ν¬κ·Έλ£Ήμ 'μ„¤μ • μ¬μ •μ' μµμ…μ΄ μ›μΈμ„μ„ μ‹λ³„ν•κ³  μ΄λ¥Ό λΉ„ν™μ„±ν™”ν•μ—¬ μ½”λ“ κΈ°λ°μ μ €μ¥ μ„μΉ μ μ–΄κ¶μ„ μ •μƒν™”ν•¨.

# 1. λ¬Έμ  μƒν™©

dbt-athena μ–΄λ‘ν„°λ¥Ό μ‚¬μ©ν•μ—¬ AWS Glue Data Catalogμ— λ©”νƒ€λ°μ΄ν„°λ¥Ό λ“±λ΅ν•λ” κ³Όμ •μ—μ„, λ¨λΈ configμ— λ…μ‹ν• S3 μ €μ¥ κ²½λ΅(`location`) νλΌλ―Έν„°κ°€ μ μ©λμ§€ μ•κ³  μλ„ν•μ§€ μ•μ€ κ²½λ΅μ— μ μ¬λλ” ν„μƒ λ°μƒ

- dbt λ¨λΈ config μ •λ³΄ :

<img width="478" height="122" alt="image" src="https://github.com/user-attachments/assets/daed9bb8-65c4-47d4-9007-77b8f9805917" />


- μ‹¤μ  μƒμ„± κ²°κ³Ό :

> μ§€μ •ν• κ²½λ΅κ°€ μ•„λ‹Β `team3-batch/gold/tables/`Β κ²½λ΅ ν•μ„μ— μ„μμ ν•΄μ‹κ°’ λ…μΉ­μ„ κ°€μ§„ Β `csv`,Β `metadata`Β νμΌ λ° λ””λ ‰ν† λ¦¬κ°€ μƒμ„±λ¨μ„ ν™•μΈ.
> 

<img width="1247" height="217" alt="image" src="https://github.com/user-attachments/assets/29a3573d-6ec1-4475-b0bd-515740e528b6" />

*λ‹Ήμ‹ S3μ— μƒμ„±λ κ²°κ³Όλ¬Όμ„ λ΅μ»¬ MinIOλ΅ μ΄κ΄€ν•μ—¬ ν™•μΈν• κ²°κ³Ό*

# 2. μ›μΈ λ¶„μ„

- AWS Athena UIλ¥Ό ν†µν•΄Β `team3_gold`Β λ°μ΄ν„°λ² μ΄μ¤ λ‚΄ ν…μ΄λΈ” μ •λ³΄λ¥Ό ν™•μΈν• κ²°κ³Ό,Β `Location`Β μ •λ³΄κ°€ dbt λ¨λΈμ—μ„ μ •μν• κ²½λ΅κ°€ μ•„λ‹Β `/gold/tables/`Β ν•μ„μ μ„μ κ²½λ΅λ΅ μƒμ„±λμ–΄ μμμ„ ν™•μΈ
    
    <img width="2222" height="966" alt="image" src="https://github.com/user-attachments/assets/0311e2b7-34c0-425c-bcf6-355d8a75ad70" />

    
- dbt λ¨λΈμΒ `config`Β λΈ”λ΅μ—Β `location`Β νλΌλ―Έν„°λ¥Ό λ…μ‹μ μΌλ΅ μ„ μ–Έν–μμ—λ„ λ¶κµ¬ν•κ³ , μ‹¤μ  ν…μ΄λΈ” μƒμ„±(CTAS) μ‹ ν•΄λ‹Ή μ„¤μ •κ°’μ΄ AWS Glue Data Catalog λ° S3 λ¬Όλ¦¬ μ €μ¥μ†μ— λ°μλμ§€ μ•μμ„ ν™•μΈν•κ³  μ„¤μ • μ μ© λ°©μ• λ¨μƒ‰

# 3. ν•΄κ²° λ°©μ•

## 3.1 dbt κ³µμ‹ λ¬Έμ„ κΈ°λ° μ„¤μ • κµ¬μ„± λ³€κ²½ μ‹λ„  β

- ddbt-athena μ„¤μ • κ°€μ΄λ“λ¥Ό μ°Έμ΅°ν•μ—¬, λ¨λΈΒ `config`Β λ‚΄μ κΈ°μ΅΄Β **μ„¤μ •λ…**μΈΒ `location`μ„ `external_location`,Β Β **`s3_data_dir`**Β λ΅ κµμ²΄ν•μ—¬ κ²½λ΅ μ§€μ • μ‹λ„
- μ–΄λ‘ν„° κ·κ²©μ— λ§κ² μμ •ν–μμ—λ„ λ¶κµ¬ν•κ³ , μ‹¤μ  S3μ— μ μ¬λλ” λ°μ΄ν„°μ κ²½λ΅λ” μ—¬μ „ν `team3-batch/gold/tables/` μ μ§€ν•λ©° μ„¤μ •μ΄ λ¬΄μ‹λλ” ν„μƒμ΄ μ§€μ†

[Amazon Athena configurations | dbt Developer Hub](https://docs.getdbt.com/reference/resource-configs/athena-configs)

## 3.2  Athena μ›ν¬κ·Έλ£Ήμ β€ν΄λΌμ΄μ–ΈνΈ μ„¤μ • μ¬μ •μβ€ μ„¤μ • `OFF`λ΅ λ³€κ²½ πΆ

### 3.2.1 κΈ°μ΅΄ μ„¤μ •

- μ‹¤μ  μΏΌλ¦¬ μ‘μ—…μ„ μν–‰ν•λ”Β `Athena μ›ν¬κ·Έλ£Ή(Workgroup)`μ μ„Έλ¶€ μ„¤μ •μ„ μ κ²€ν• κ²°κ³Ό,Β **`'ν΄λΌμ΄μ–ΈνΈ μ„¤μ • μ¬μ •μ(Override client-side settings)'`**Β μµμ…μ΄ `ν™μ„±ν™”`λ μƒνƒμ„μ„ ν™•μΈ
    - **ν΄λΌμ΄μ–ΈνΈ μ„¤μ • μ¬μ •μ** : **`On`**
    - **μΏΌλ¦¬ κ²°κ³Ό μ„μΉ** : `/gold/table`
- μ΄ μµμ…μ΄ ν™μ„±ν™”λλ©΄ dbt(ν΄λΌμ΄μ–ΈνΈ)κ°€ μΏΌλ¦¬ μ‹ μ „λ‹¬ν•λ” κ°λ³„Β `location`Β μ„¤μ •λ³΄λ‹¤, μ›ν¬κ·Έλ£Ήμ— λ―Έλ¦¬ μ§€μ •λΒ **'μΏΌλ¦¬ κ²°κ³Ό μ„μΉ'**Β μ„¤μ •μ΄ κ°•μ  μ°μ„ μμ„λ¥Ό κ°–κ²λμ–΄ λ³Έ μ΄μκ°€ λ°μƒν•¨ ν™•μΈ

### 3.2.2 μ„¤μ • λ³€κ²½

- Athena μ›ν¬κ·Έλ£Ή λ‚΄ ν•΄λ‹Ή μµμ…μ„ `λΉ„ν™μ„±ν™”(OFF)`λ΅ **λ³€κ²½**ν•μ—¬, dbt λ¨λΈμ—μ„ μ„ μ–Έν• S3 κ²½λ΅(`location`)κ°€ μ‹¤μ  λ¬Όλ¦¬ μ €μ¥μ†μ— κ·Έλ€λ΅ λ°μλλ„λ΅ μ μ–΄κ¶μ„ νλ³µ
    
    <img width="2678" height="642" alt="image" src="https://github.com/user-attachments/assets/da7731af-77fe-4360-b317-8ec79b17e339" />


### 3.3.3 μ„¤μ • λ³€κ²½ κ²°κ³Ό

- AWS Athena UIλ¥Ό ν†µν•΄ `Location`Β μ •λ³΄κ°€ dbt λ¨λΈμ—μ„ μ •μν• κ²½λ΅μ™€ μΌμΉν•¨ ν™•μΈ
    
    <img width="2216" height="866" alt="image" src="https://github.com/user-attachments/assets/0578da56-5ac7-48a4-b142-d801a10c6a71" />

    

## 4. κΈ°μ΅΄ κµ¬μ΅° β†’ λ³€κ²½λ κµ¬μ΅°

| **κµ¬λ¶„** | **ν•­λ©** | **AS-IS (κΈ°μ΅΄ κµ¬μ΅°)** | **TO-BE (κ°μ„  κµ¬μ΅°)** |
| --- | --- | --- | --- |
| **Athena Workgroup** | **`ν΄λΌμ΄μ–ΈνΈ μ„¤μ • μ¬μ •μ(Override client-side settings)`** | **On** | **Off** |


## 5. λ³€κ²½μΌλ΅ μΈν•΄ κ°μ„ λ λ¶€λ¶„

- **λ°μ΄ν„° μ μ¬ μ •ν•©μ„± λ° κ±°λ²„λ„μ¤ ν™•λ³΄**: Athena μ›ν¬κ·Έλ£Ήμ κ°•μ  κ²½λ΅ ν• λ‹Ή λ¬Έμ λ¥Ό ν•΄κ²°ν•¨μΌλ΅μ¨, λΉ„μ¦λ‹μ¤ λ΅μ§μ— λ”°λΌ μ„¤κ³„λ S3 Gold Layer λ””λ ‰ν† λ¦¬ κµ¬μ΅°μ— λ°μ΄ν„°κ°€ μ •ν™•ν μ μ¬λ¨.
- **μ½”λ“ κΈ°λ°μ μΈν”„λΌ μ μ–΄κ¶ κ°•ν™”**: μΈν”„λΌ(Athena) μ„¤μ •μ„ λ§¤λ² μλ™μΌλ΅ μμ •ν•  ν•„μ” μ—†μ΄, dbt λ¨λΈ μ½”λ“λ¥Ό ν†µν•΄ S3 μ €μ¥ μ„μΉλ¥Ό μ μ—°ν•κ³  λ…λ¦½μ μΌλ΅ κ΄€λ¦¬ν•  μ μκ² λ¨.